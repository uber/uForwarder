/*
 * This file was generated by the Gradle 'init' task.
 */

plugins {
    id 'base'
    id 'com.bmuschko.docker-remote-api' version '9.3.4'
}

import com.bmuschko.gradle.docker.tasks.image.Dockerfile
import com.bmuschko.gradle.docker.tasks.image.DockerBuildImage

tasks.register('prepareDockerFile', Copy) {
    from file('docker/entrypoint.sh'), project(":uforwarder").tasks.bootJar
    into layout.buildDirectory.dir("docker")
}

tasks.register('createDockerFile', Dockerfile) {
    dependsOn('prepareDockerFile')
    from('eclipse-temurin:21.0.6_7-jdk-noble')
    copyFile('entrypoint.sh','/opt/uforwarder/')
    copyFile("uforwarder-boot-${mavenVersion}.jar",'/opt/uforwarder/bin_main.jar')
    runCommand('chmod +x /opt/uforwarder/entrypoint.sh')
    environmentVariable('UFORWARDER_PROFILE', 'uforwarder-controller')
    environmentVariable('UFORWARDER_CONTROLLER_CONNECT', 'controller:8087')
    environmentVariable('UFORWARDER_KAFKA_CONNECT', 'kafka:9092')
    environmentVariable('UFORWARDER_ZOOKEEPER_CONNECT', 'zookeeper:2181/uforwarder')
    environmentVariable('UFORWARDER_MEMORY_LIMIT_MB', '512')
    workingDir('/opt/uforwarder')
    defaultCommand('/opt/uforwarder/entrypoint.sh')
}

tasks.register('buildImage', DockerBuildImage) {
    dependsOn('createDockerFile')
    images.add('uforwarder:0.1')
}

tasks.getByName('build').dependsOn('buildImage')
